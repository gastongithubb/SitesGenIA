<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nube de Ideas GenIA</title>
  <style>
    :root {
      --azul-konecta: #2800c8;
      --gris-suave: #fffff;
      --texto: #333;
      --borde: #dcdcdc;
    }

    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: var(--gris-suave);
      margin: 0;
      padding: 40px 20px;
      text-align: center;
    }

    h2 {
      color: var(--azul-konecta);
      font-size: 28px;
      margin-bottom: 10px;
    }

    .contador {
      font-size: 16px;
      color: #555;
      margin-bottom: 20px;
    }

    .agradecimiento {
      font-size: 16px;
      color: #008000;
      margin-bottom: 20px;
    }

    .idea-card {
      padding: 25px;
      margin: 0 auto;
      max-width: 600px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      display: none;
      text-align: left;
      animation: fadeIn 0.8s ease-in-out;
      color: var(--texto);
    }

    .idea-card.active {
      display: block;
    }

    .idea-card h3 {
      margin-top: 0;
      font-size: 20px;
    }

    .idea-card p {
      margin: 8px 0;
      font-size: 16px;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }

    .color-1 { background: #e6e9ff; border-left: 6px solid #2800c8; }
    .color-2 { background: #e0f7fa; border-left: 6px solid #00acc1; }
    .color-3 { background: #fce4ec; border-left: 6px solid #d81b60; }
    .color-4 { background: #f3e5f5; border-left: 6px solid #8e24aa; }
    .color-5 { background: #fff3e0; border-left: 6px solid #fb8c00; }

    .boton-formulario {
      margin-top: 20px;
      display: inline-block;
      background-color: #2800c8;
      color: white;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 8px;
      text-decoration: none;
      transition: background 0.3s ease;
    }

    .boton-formulario:hover {
      background-color: #1e009e;
    }

    .footer {
      margin-top: 30px;
      font-size: 14px;
      color: #888;
    }

    .error-message {
      color: #d32f2f;
      font-size: 14px;
      margin: 20px auto;
      max-width: 600px;
      padding: 15px;
      background: #ffebee;
      border-radius: 8px;
      display: none;
    }

    .loading {
      color: #555;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <h2>üåü Historias GenIA: Nube de Ideas</h2>
  <div class="contador loading" id="contadorCasos">‚è≥ Cargando datos...</div>
  <div class="agradecimiento" id="mensajeAgradecimiento"></div>
  <div class="error-message" id="errorMessage"></div>
  <div id="ideasContainer"></div>

  <a class="boton-formulario" href="https://docs.google.com/forms/d/e/1FAIpQLSeF1MGVmSmG72-_wcSHX0-tnLhGKuxHA6CK4qoqtU8A_5hYsA/viewform" target="_blank">Compart√≠ tu caso</a>
  <div class="footer">Casos reales + ejemplos testigos para inspirar a todo el equipo</div>

  <script>
    const ideasFijas = [
      {
        nombre: "Atenci√≥n al Cliente",
        titulo: "Autorizaci√≥n urgente con empat√≠a",
        descripcion: "Respuesta por WhatsApp a un paciente que necesitaba autorizaci√≥n urgente.",
        impacto: "Reducci√≥n del tiempo de respuesta en un 40%."
      },
      {
        nombre: "Atenci√≥n al Cliente",
        titulo: "Consulta sobre cobertura de medicamentos",
        descripcion: "Explicaci√≥n formal y c√°lida sobre cobertura de medicamentos.",
        impacto: "Evit√≥ una segunda consulta."
      },
      {
        nombre: "Atenci√≥n al Cliente",
        titulo: "Reclamo por facturaci√≥n",
        descripcion: "Mensaje claro y asertivo explicando el proceso de revisi√≥n.",
        impacto: "Mejor percepci√≥n del servicio."
      },
      {
        nombre: "Atenci√≥n a Discapacidad",
        titulo: "Transporte cubierto por CUD",
        descripcion: "Respuesta con marco legal y pasos para solicitar el beneficio.",
        impacto: "Acceso sin demoras y con claridad."
      },
      {
        nombre: "Operaciones & CX",
        titulo: "An√°lisis de reclamos con propuesta de mejora",
        descripcion: "Automatizaci√≥n en validaci√≥n de datos.",
        impacto: "Reducci√≥n del 25% en reclamos."
      }
    ];

    const ideasContainer = document.getElementById('ideasContainer');
    const contadorCasos = document.getElementById('contadorCasos');
    const mensajeAgradecimiento = document.getElementById('mensajeAgradecimiento');
    const errorMessage = document.getElementById('errorMessage');
    let todasLasIdeas = [];
    let index = 0;
    let intervalo = null;

    function mostrarError(mensaje) {
      errorMessage.textContent = mensaje;
      errorMessage.style.display = 'block';
      console.error(mensaje);
    }

    function mostrarIdea() {
      if (todasLasIdeas.length === 0) return;
      ideasContainer.innerHTML = '';
      const idea = todasLasIdeas[index];
      const colorClass = `color-${(index % 5) + 1}`;
      const div = document.createElement('div');
      div.className = `idea-card active ${colorClass}`;
      div.innerHTML = `
        <h3>${idea.titulo} ‚Äì ${idea.nombre}</h3>
        <p><strong>Descripci√≥n:</strong> ${idea.descripcion}</p>
        <p><strong>Impacto:</strong> ${idea.impacto}</p>
      `;
      ideasContainer.appendChild(div);
      index = (index + 1) % todasLasIdeas.length;
    }

    function iniciarRotacion() {
      if (intervalo) clearInterval(intervalo);
      mostrarIdea();
      intervalo = setInterval(mostrarIdea, 8000);
    }

    async function cargarDesdeGoogleSheet() {
      // ID original del sheet (no el ID de publicaci√≥n)
      const SHEET_ID = '10XU4PMCJeAE5az01DB6jagNZDmigO6xXsV-kTmdMjWA';
      
      // URL usando Google Visualization API (funciona con sheets p√∫blicos)
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Respuestas%20de%20formulario%201`;

      try {
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        
        // Google devuelve JSONP, necesitamos extraer el JSON
        const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/);
        
        if (!jsonString) {
          throw new Error('No se pudo parsear la respuesta de Google Sheets');
        }
        
        const data = JSON.parse(jsonString[1]);
        
        if (!data.table || !data.table.rows) {
          throw new Error('Formato de datos inesperado');
        }
        
        const rows = data.table.rows;
        const headers = data.table.cols.map(col => col.label || '');
        
        console.log('Headers encontrados:', headers);
        console.log('Total de filas:', rows.length);
        
        // Buscar √≠ndices de columnas (case insensitive y flexible)
        const areaIdx = headers.findIndex(h => 
          h.toLowerCase().includes('√°rea') || h.toLowerCase().includes('area')
        );
        const nombreIdx = headers.findIndex(h => 
          h.toLowerCase().includes('nombre') || h.toLowerCase().includes('t√≠tulo')
        );
        const impactoIdx = headers.findIndex(h => 
          h.toLowerCase().includes('impacto') || h.toLowerCase().includes('descripci√≥n')
        );
        const publicarIdx = headers.findIndex(h => 
          h.toLowerCase().includes('publicar') || h.toLowerCase().includes('publique')
        );
        
        console.log('√çndices:', { areaIdx, nombreIdx, impactoIdx, publicarIdx });
        
        const ideasPublicadas = [];
        
        // Procesar filas
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i].c;
          if (!row) continue;
          
          // Si hay columna de publicar, verificarla
          let debePublicar = true;
          if (publicarIdx !== -1 && row[publicarIdx]) {
            const publicar = row[publicarIdx].v?.toString().toLowerCase().trim();
            debePublicar = (publicar === 's√≠' || publicar === 'si');
          }
          
          if (debePublicar) {
            const area = areaIdx !== -1 && row[areaIdx] ? row[areaIdx].v : 'Sin √°rea';
            const nombre = nombreIdx !== -1 && row[nombreIdx] ? row[nombreIdx].v : 'Caso compartido';
            const impacto = impactoIdx !== -1 && row[impactoIdx] ? row[impactoIdx].v : 'Sin descripci√≥n';
            
            ideasPublicadas.push({
              nombre: area,
              titulo: nombre,
              descripcion: impacto,
              impacto: 'Caso enviado por formulario'
            });
          }
        }
        
        console.log('Ideas publicadas:', ideasPublicadas.length);
        
        // Siempre combinar ideas fijas + publicadas
        todasLasIdeas = [...ideasFijas, ...ideasPublicadas];
        
        const totalCasos = ideasFijas.length + ideasPublicadas.length;
        contadorCasos.textContent = `üßÆ Total de casos: ${totalCasos} (${ideasFijas.length} ejemplos + ${ideasPublicadas.length} del equipo)`;
        contadorCasos.className = 'contador';
        
        if (ideasPublicadas.length > 0) {
          mensajeAgradecimiento.textContent = `üí¨ ¬°Gracias por compartir tu experiencia! Tu aporte inspira a todo el equipo.`;
        } else {
          mensajeAgradecimiento.textContent = ``;
        }
        
        index = 0;
        iniciarRotacion();
        
      } catch (error) {
        console.error('Error detallado:', error);
        mostrarError(`Error al cargar datos: ${error.message}. Mostrando ejemplos.`);
        todasLasIdeas = [...ideasFijas];
        contadorCasos.textContent = `üßÆ Mostrando ejemplos`;
        contadorCasos.className = 'contador';
        index = 0;
        iniciarRotacion();
      }
    }

    // Iniciar carga cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', cargarDesdeGoogleSheet);
    } else {
      cargarDesdeGoogleSheet();
    }
  </script>
</body>
</html>
